Project: Simple NPZ mixed-layer model for nutrient (N), phytoplankton (P), and zooplankton (Z) dynamics.

Assessment
- Model fit to data:
  - I do not currently have the residuals file you referenced. Please share it so I can quantify fit quality and identify any systematic biases (e.g., peak timing, amplitude, phase shifts).
  - Qualitatively, the current structure can fit classic bloom-and-graze dynamics, but static light availability can lead to biased peaks (overprediction during blooms and underprediction during post-bloom decline) if self-shading is important in the dataset.

- Alignment with project context:
  - The model captures core NPZ processes in a mixed layer: Monod nutrient-limited phytoplankton growth, co-limitation with light, temperature-modified rates, zooplankton grazing with a Hill functional response, linear and quadratic mortalities, mixed-layer exchange/entrainment, and rapid recycling via mortality, excretion, and egestion.
  - This addresses the project context well for a “simple” NPZ. It explicitly simulates N, P, Z concentrations and includes realistic environmental modifiers (Q10) and physical exchange (D_mix).

- Potentially missing or oversimplified processes:
  - Light limitation is static (L_avail is a constant). In mixed layers with variable biomass, self-shading alters effective light, especially during blooms.
  - No explicit detritus/POC/DOM pool: all non-assimilated and mortality flows are instantly remineralized to N. This can be acceptable for a simple model but may miss lagged recycling and sinking.
  - Fixed stoichiometry and constant assimilation efficiency (AE_Z): food quality effects are ignored.
  - No explicit seasonal/diurnal forcing of light or temperature beyond constant T and L_avail.
  - Quadratic zooplankton mortality (gamma_Z) is not temperature-modified; literature is mixed on this, so status quo is reasonable but could be revisited.

Review of parameter values
- Most parameters have plausible values with literature-backed ranges. Q10_P ≈ 2.06 and Q10_Z ≈ 2.1 are typical.
- Light parameters (L_avail, K_L) are static; if the dataset spans variable biomass conditions, a constant L_avail can act as a placeholder for missing self-shading or seasonal light.
- No structural red flags from current values that demand re-scaling of existing equations, but the static light term is a likely source of bias where bloom magnitude influences light.

Chosen improvement
- Add phytoplankton self-shading to produce a dynamic light limitation term:
  - Rationale: In mixed layers, as P increases, light availability is reduced by absorption/scattering (Beer–Lambert-like attenuation). A static L_avail can overpredict bloom growth/peak when self-shading is important. Introducing self-shading provides a negative feedback that is ecologically realistic and can alleviate systematic residuals (e.g., overestimation at bloom peaks).
  - Mathematical form: L_eff = L_avail * exp(-k_shade * P_prev); fL = L_eff / (K_L + L_eff)
    - k_shade ≥ 0 controls shading strength (units m^3 g C^-1 so that k_shade * P is dimensionless).
    - This preserves the original light half-saturation structure while letting light vary with biomass.
  - Complexity tradeoff: Adds a single parameter and one simple nonlinearity. This is a minimal, high-leverage improvement consistent with the project’s “simple” scope, avoiding the complexity of adding a full detrital pool or stoichiometry.

Implementation summary
- parameters.json: Added parameter k_shade with bounds [0, 5] (nonnegative; upper bound liberal).
- model.cpp:
  - Introduced PARAMETER(k_shade).
  - Replaced static light limitation with dynamic L_eff at each time step based on P_prev.
  - Stored L_eff as a diagnostic output (L_eff_pred).
  - Added a gentle smooth penalty to keep k_shade within a plausible range.
- Data leakage caution: Predictions use only previous-step states (P_prev), never current observed values; initial conditions still seeded from the first observations as before.

Next steps
- Please provide the residuals file so I can:
  - Verify if biases at high P are reduced (especially in P residuals during bloom peaks).
  - Re-tune k_shade bounds/priors if necessary and determine whether seasonal light forcing is needed.
- If residuals still show over-fast recycling or delayed peaks, the next candidates would be:
  - Introduce a simple detritus pool with finite remineralization.
  - Allow AE_Z to vary with resource level or temperature.
